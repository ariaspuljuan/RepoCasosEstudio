<!-- estudio-optimizacion.component.html -->
<div class="container mt-4">
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h1 class="h3 mb-0">Optimización de Plan de Estudio</h1>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <form [formGroup]="estudianteForm">
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h2 class="h5 mb-0">Parámetros Generales</h2>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="diasDisponibles" class="form-label"
                      >Días disponibles para estudiar</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="diasDisponibles"
                      formControlName="dias_disponibles"
                    />
                    <div
                      class="text-danger"
                      *ngIf="
                        estudianteForm.get('dias_disponibles')?.invalid &&
                        estudianteForm.get('dias_disponibles')?.touched
                      "
                    >
                      Debe ingresar entre 1 y 30 días
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="tiempoPorDia" class="form-label"
                      >Horas disponibles por día</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="tiempoPorDia"
                      formControlName="tiempo_por_dia"
                    />
                    <div
                      class="text-danger"
                      *ngIf="
                        estudianteForm.get('tiempo_por_dia')?.invalid &&
                        estudianteForm.get('tiempo_por_dia')?.touched
                      "
                    >
                      Debe ingresar entre 1 y 24 horas
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>

          <form [formGroup]="temasForm">
            <div class="card">
              <div
                class="card-header bg-light d-flex justify-content-between align-items-center"
              >
                <h2 class="h5 mb-0">Temas a Estudiar</h2>
                <span
                  class="badge"
                  [ngClass]="
                    verificarPesoTotal() === 100 ? 'bg-success' : 'bg-warning'
                  "
                >
                  Peso Total: {{ verificarPesoTotal() }}%
                </span>
              </div>
              <div class="card-body">
                <div formArrayName="temas">
                  <div
                    class="mb-3 p-3 border rounded"
                    *ngFor="let tema of temasArray.controls; let i = index"
                    [formGroupName]="i"
                  >
                    <div class="row">
                      <div class="col-md-6 mb-2">
                        <label class="form-label">Nombre del tema</label>
                        <input
                          type="text"
                          class="form-control"
                          formControlName="nombre"
                        />
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label"
                          >Peso en la evaluación (%)</label
                        >
                        <input
                          type="number"
                          class="form-control"
                          formControlName="peso"
                        />
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-5 mb-2">
                        <label class="form-label">Dificultad (1-10)</label>
                        <input
                          type="number"
                          class="form-control"
                          formControlName="dificultad"
                        />
                      </div>
                      <div class="col-md-5 mb-2">
                        <label class="form-label">Eficiencia (1-10)</label>
                        <input
                          type="number"
                          class="form-control"
                          formControlName="eficiencia"
                        />
                      </div>
                      <div class="col-md-2 d-flex align-items-end mb-2">
                        <button
                          type="button"
                          class="btn btn-danger w-100"
                          (click)="eliminarTema(i)"
                        >
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="d-flex justify-content-between mt-3">
                  <button
                    type="button"
                    class="btn btn-outline-primary"
                    (click)="agregarTema()"
                  >
                    <i class="bi bi-plus-circle"></i> Agregar Tema
                  </button>
                  <button
                    type="button"
                    class="btn btn-success"
                    (click)="calcularOptimizacion()"
                    [disabled]="
                      estudianteForm.invalid ||
                      temasForm.invalid ||
                      verificarPesoTotal() !== 100 ||
                      calculando
                    "
                  >
                    <i class="bi bi-calculator"></i> Calcular Plan Óptimo
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>

        <div class="col-md-6" *ngIf="resultado">
          <div class="card">
            <div class="card-header bg-success text-white">
              <h2 class="h5 mb-0">Calendario Óptimo de Estudio</h2>
            </div>
            <div class="card-body">
              <div class="alert alert-info mb-3">
                <strong>Nota esperada estimada:</strong>
                {{ resultado.nota_esperada | number : "1.2-2" }}
                (en escala relativa a factores de aprendizaje)
              </div>

              <!-- Calendario de estudio -->
              <div class="card mb-3" *ngFor="let dia of dias">
                <div class="card-header bg-light">
                  <h3 class="h6 mb-0">{{ dia }}</h3>
                </div>
                <ul class="list-group list-group-flush">
                  <li
                    class="list-group-item d-flex justify-content-between align-items-center"
                    *ngFor="let actividad of resultado.calendario[dia]"
                  >
                    <span>{{ actividad.tema }}</span>
                    <span class="badge bg-primary rounded-pill"
                      >{{ actividad.horas }} horas</span
                    >
                  </li>
                  <li
                    class="list-group-item text-center text-muted"
                    *ngIf="resultado.calendario[dia].length === 0"
                  >
                    No hay actividades asignadas para este día
                  </li>
                </ul>
              </div>

              <!-- Resumen por tema -->
              <h3 class="h5 mt-4 mb-3">Resumen por tema</h3>
              <div class="table-responsive">
                <table class="table table-striped table-bordered">
                  <thead class="table-primary">
                    <tr>
                      <th>Tema</th>
                      <th>Horas Totales</th>
                      <th>Peso (%)</th>
                      <th>Dificultad</th>
                      <th>Eficiencia</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let tema of temas">
                      <td>{{ tema }}</td>
                      <td>{{ resultado.resumen_temas[tema].horas_totales }}</td>
                      <td>{{ resultado.resumen_temas[tema].peso }}%</td>
                      <td>{{ resultado.resumen_temas[tema].dificultad }}</td>
                      <td>{{ resultado.resumen_temas[tema].eficiencia }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Actualizacion Y Mejoras -->

              <!-- Tabla de Puntos de Calificación Estimados -->
              <h3 class="h5 mt-4 mb-3">Puntos de Calificación Estimados</h3>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead class="table-primary">
                    <tr>
                      <th rowspan="2" class="align-middle">Día de estudio</th>
                      <th colspan="4" class="text-center">Curso</th>
                    </tr>
                    <tr>
                      <th *ngFor="let tema of temas; let i = index">
                        {{ i + 1 }}
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let dia of dias; let i = index">
                      <td class="font-weight-bold">{{ i + 1 }}</td>
                      <td *ngFor="let tema of temas">
                        {{
                          calcularPuntosPorDiaTema(dia, tema) | number : "1.0-1"
                        }}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Tabla de Etapas por Día y Resultados Dinámicos -->
              <h3 class="h5 mt-4 mb-3">Resultados del Análisis Dinámico</h3>
              <div
                class="table-responsive"
                *ngFor="let etapa of etapasAnalisis; let s = index"
              >
                <h4 class="h6 mt-3">S{{ s + 1 }}/x{{ s + 1 }}</h4>
                <table class="table table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th></th>
                      <th *ngFor="let i of [1, 2, 3, 4]">{{ i }}</th>
                      <th>f*</th>
                      <th>x*</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let row of etapa.datos; let j = index">
                      <td [ngClass]="{ 'bg-primary text-white': true }">
                        {{ row.estado }}
                      </td>
                      <td
                        *ngFor="let val of [1, 2, 3, 4]; let k = index"
                        [ngClass]="{
                          'bg-warning':
                            k < temas.length && esDecisionOptima(s, j, k),
                          'bg-success':
                            k < temas.length && esMejorResultado(s, j, k)
                        }"
                      >
                        {{ obtenerValorTabla(s, j, k) }}
                      </td>
                      <td>{{ row.valorOptimo }}</td>
                      <td>{{ row.decisionOptima }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Diagrama de Red -->
              <h3 class="h5 mt-4 mb-3">Diagrama de Red de la Solución</h3>
              <div class="card">
                <div class="card-body">
                  <div class="network-diagram">
                    <!-- Aquí se insertará el diagrama de red generado con Mermaid o SVG -->
                    <div id="network-diagram-container" class="text-center">
                      <svg
                        viewBox="0 0 800 400"
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-100"
                      >
                        <!-- Nodos representando días -->
                        <g id="nodes">
                          <g *ngFor="let dia of dias; let i = index">
                            <circle
                              [attr.cx]="100 + i * 150"
                              cy="100"
                              r="30"
                              class="fill-primary"
                            />
                            <text
                              [attr.x]="100 + i * 150"
                              y="105"
                              text-anchor="middle"
                              class="text-white"
                            >
                              Día {{ i + 1 }}
                            </text>
                          </g>
                        </g>

                        <!-- Conexiones entre nodos -->
                        <g id="connections">
                          <g *ngFor="let conexion of conexionesSVG">
                            <path
                              [attr.d]="
                                'M' +
                                conexion.x1 +
                                ' 100 L' +
                                conexion.x2 +
                                ' 100'
                              "
                              stroke="#333"
                              stroke-width="2"
                              marker-end="url(#arrowhead)"
                            />
                          </g>
                        </g>

                        <!-- Actividades por día -->
                        <g id="activities">
                          <g *ngFor="let dia of dias; let i = index">
                            <g
                              *ngFor="
                                let actividad of resultado.calendario[dia];
                                let j = index
                              "
                            >
                              <rect
                                [attr.x]="70 + i * 150"
                                [attr.y]="150 + j * 50"
                                width="60"
                                height="40"
                                rx="5"
                                class="fill-light border"
                              />
                              <text
                                [attr.x]="100 + i * 150"
                                [attr.y]="175 + j * 50"
                                text-anchor="middle"
                                font-size="12"
                              >
                                {{ actividad.tema.substring(0, 8) }}
                                {{ actividad.horas }}h
                              </text>
                            </g>
                          </g>
                        </g>

                        <!-- Definición de marcadores -->
                        <defs>
                          <marker
                            id="arrowhead"
                            markerWidth="10"
                            markerHeight="7"
                            refX="9"
                            refY="3.5"
                            orient="auto"
                          >
                            <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
                          </marker>
                        </defs>
                      </svg>
                    </div>
                  </div>
                </div>
              </div>

              <button class="btn btn-secondary mt-3" (click)="reiniciar()">
                <i class="bi bi-arrow-left"></i> Volver a calcular
              </button>
            </div>
          </div>
        </div>

        <!-- Mostrar mensaje de carga -->
        <div class="col-md-6" *ngIf="calculando">
          <div class="card">
            <div class="card-body text-center p-5">
              <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Calculando...</span>
              </div>
              <h3 class="h5">Calculando plan óptimo de estudio...</h3>
              <p class="text-muted">Esto puede tomar unos momentos</p>
            </div>
          </div>
        </div>

        <!-- Mostrar mensaje de error -->
        <div class="col-md-6" *ngIf="error">
          <div class="alert alert-danger">
            <h3 class="h5">Error</h3>
            <p>{{ error }}</p>
            <button class="btn btn-outline-danger" (click)="error = null">
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
